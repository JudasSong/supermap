<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>几何查询</title>
    <script type="text/javascript" include="bootstrap" src="../js/include-web.js"></script>
    <script type="text/javascript" exclude="iclient-classic" src="../../dist/include-classic.js"></script>
    <style type="text/css">
    body {
        margin: 0;
        overflow: hidden;
        background: #fff;
        width: 100%;
        height: 100%
    }

    #map {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 1px solid #3473b7;
    }

    #toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        text-align: center;
        z-index: 100;
        border-radius: 4px;
    }
    </style>
</head>

<body>
    <div id="toolbar" class="panel panel-primary">
        <div class='panel-heading'>
            <h5 class='panel-title text-center'>几何查询</h5></div>
        <div class='panel-body content'>
            <input type="button" class="btn btn-default" value="点" onclick="drawGeometry3()" />
        </div>
    </div>
    <div id="map"></div>
    <script>
    var map, local, layer, vectorLayer, vectorLayer1, markerLayer, drawPolygon, drawPoint, pointLayer,
        style = {
            strokeColor: "#304DBE",
            strokeWidth: 1,
            pointerEvents: "visiblePainted",
            fillColor: "#304DBE",
            fillOpacity: 0.5
        },
        host = window.isLocal ? window.server : "http://10.10.0.113:8090",
        url = host + "/iserver/services/map-China-XinJiang/rest/maps/XinJiang_Citys@China_Citys";
    url1 = host + "/iserver/services/data-China-XinJiang/rest/data";

    init();

    function init() {
        layer = new SuperMap.Layer.TiledDynamicRESTLayer("XinJiang_Citys@China_Citys", url, {
            transparent: true,
            cacheEnabled: true
        }, { maxResolution: "auto" });
        layer.events.on({ "layerInitialized": addLayer });
        vectorLayer = new SuperMap.Layer.Vector("Vector Layer");
        vectorLayer1 = new SuperMap.Layer.Vector("Vector Layer1");
        markerLayer = new SuperMap.Layer.Markers("Markers");

        //点查询
        drawPoint = new SuperMap.Control.DrawFeature(vectorLayer, SuperMap.Handler.Point);
        drawPoint.events.on({ "featureadded": drawPointCompleted });

        //新建点矢量图层
        pointLayer = new SuperMap.Layer.Vector("pointLayer");

        map = new SuperMap.Map("map", {
            controls: [
                new SuperMap.Control.ScaleLine(),
                new SuperMap.Control.Zoom(),
                new SuperMap.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                }),
                drawPoint
            ]
        });
        map.addControl(new SuperMap.Control.LayerSwitcher(), new SuperMap.Pixel(42, 80));
        map.events.on({
            'click': function(evt) {
                // console.log('evt=====', evt);
                var pixel = new SuperMap.Pixel(evt.clientX, evt.clientY),
                lonlat = map.getLonLatFromPixel(pixel);
                queryBySQL(lonlat)
            }
        })
    }

    function queryBySQL(lonlat) {
        pointLayer.removeAllFeatures();
        var point = new SuperMap.Geometry.Point(lonlat.lon, lonlat.lat);
        var feature = new SuperMap.Feature.Vector(point);
        pointLayer.addFeatures([feature]);
        // console.log('feature--------',feature)
        // return


        var queryParam, queryByGeometryParameters, queryService;
        queryParam = new SuperMap.REST.FilterParameter({
            name: "XinJiang_Citys@China_Citys"
        });
        queryByGeometryParameters = new SuperMap.REST.QueryByGeometryParameters({
            queryParams: [queryParam],
            geometry: feature.geometry
            // spatialQueryMode: SuperMap.REST.SpatialQueryMode.INTERSECT
        });
        queryService = new SuperMap.REST.QueryByGeometryService(url, {
            eventListeners: {
                "processCompleted": processCompleted,
                "processFailed": processFailed
            }
        });
        queryService.processAsync(queryByGeometryParameters);
    }

    function processBySQLCompleted(queryEventArgs) {
        var i, j, feature,
            result = queryEventArgs.result;
        console.log('queryBySQL result++++++', result)
        // if (result && result.recordsets) {
        //     for (i = 0; i < result.recordsets.length; i++) {
        //         if (result.recordsets[i].features) {
        //             for (j = 0; j < result.recordsets[i].features.length; j++) {
        //                 feature = result.recordsets[i].features[j];
        //                 feature.style = style;
        //                 vectorLayer.addFeatures(feature);
        //             }
        //         }
        //     }
        // }
    }


    function processBySQLFailed(e) {
        console.log(e)
    }


    function addLayer() {
        map.addLayers([layer, vectorLayer, vectorLayer1, markerLayer, pointLayer]);
        map.setCenter(new SuperMap.LonLat(9453654.35, 5190100.64), 0);
    }

    //画点
    function drawGeometry3() {
        //先清除上次的显示结果
        vectorLayer.removeAllFeatures();
        vectorLayer1.removeAllFeatures();
        markerLayer.clearMarkers();
        drawPoint.activate();
    }

    function drawPointCompleted(drawGeometryArgs) {
        var feature = new SuperMap.Feature.Vector();
        console.log('drawGeometryArgs', drawGeometryArgs)
        feature.geometry = drawGeometryArgs.feature.geometry,
            feature.style = style;
        vectorLayer.addFeatures(feature);

        var queryParam, queryByGeometryParameters, queryService;
        queryParam = new SuperMap.REST.FilterParameter({
            name: "XinJiang_Citys@China_Citys"
        });
        queryByGeometryParameters = new SuperMap.REST.QueryByGeometryParameters({
            queryParams: [queryParam],
            geometry: drawGeometryArgs.feature.geometry,
            spatialQueryMode: SuperMap.REST.SpatialQueryMode.INTERSECT
        });
        queryService = new SuperMap.REST.QueryByGeometryService(url, {
            eventListeners: {
                "processCompleted": processCompleted,
                "processFailed": processFailed
            }
        });
        queryService.processAsync(queryByGeometryParameters);
    }

    function processCompleted(queryEventArgs) {
        drawPoint.deactivate();
        var i, j, result = queryEventArgs.result;

        console.log('result+++++', result)
        if (result && result.recordsets) {
            for (i = 0, recordsets = result.recordsets, len = recordsets.length; i < len; i++) {
                if (recordsets[i].features) {
                    for (j = 0; j < recordsets[i].features.length; j++) {
                        var feature = recordsets[i].features[j];
                        var point = feature.geometry;
                        if (point.CLASS_NAME == SuperMap.Geometry.Point.prototype.CLASS_NAME) {
                            var size = new SuperMap.Size(44, 33),
                                offset = new SuperMap.Pixel(-(size.w / 2), -size.h),
                                icon = new SuperMap.Icon("./images/marker.png", size, offset);
                            markerLayer.addMarker(new SuperMap.Marker(new SuperMap.LonLat(point.x, point.y), icon));
                        } else {
                            feature.style = style;
                            vectorLayer1.addFeatures(feature);
                        }

                    }
                }
            }
        }
    }

    function processFailed(e) {
        showAlert(e.error.errorMsg);
    }

    //显示提示框
    var alertDiv;

    function showAlert(msg) {
        var className = "alert-success";
        closeAlert();
        if (!$('#msg_container')[0]) {
            alertDiv = $("<div class='alert alert-dismissible' id='msg_container' role='alert' " +
                "style='z-index:800;position: absolute;top: 20px;left: 40%;width:250px;display: none'>" +
                "<button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button>" +
                "<strong><p id='msg' style='word-wrap: break-word'></p></strong></div>");
            $('body').append(alertDiv)
        }
        $('.close').on('click', function() {
            $(alertDiv).remove();
        });
        $('#msg_container').addClass(className);
        $('#msg_container').slideDown(300);
        $('#msg').html(msg);
    }

    function closeAlert() {
        if (alertDiv) {
            $(alertDiv).remove();
        }
    }
    </script>
</body>

</html>