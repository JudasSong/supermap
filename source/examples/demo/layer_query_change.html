<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>新疆地图查询</title>
    <script type="text/javascript" include="bootstrap" src="../js/include-web.js"></script>
    <script type="text/javascript" exclude="iclient-classic" src="../../dist/include-classic.js"></script>
    <style type="text/css">
    body {
        margin: 0;
        overflow: hidden;
        background: #fff;
        width: 100%;
        height: 100%
    }

    #map {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 1px solid #3473b7;
    }

    #toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        text-align: center;
        z-index: 100;
        border-radius: 4px;
    }
    </style>
</head>

<body>
    <!-- <div id="toolbar" class="panel panel-primary">
        <div class='panel-heading'>
            <h5 class='panel-title text-center'>几何查询</h5></div>
        <div class='panel-body content'>
            <input type="button" class="btn btn-default" value="点" onclick="drawGeometry3()" />
        </div>
    </div> -->
    <div id="map"></div>
    <script type="text/javascript" src="config.js"></script>
    <script>
    var map,
        local,
        areaLayerArray = new Array(),
        areaLayerObj = new Object(),
        vectorLayer,
        pointLayer,
        style = {
            strokeColor: "#304DBE",
            strokeWidth: 1,
            pointerEvents: "visiblePainted",
            fillColor: "#304DBE",
            fillOpacity: 0.5
        },
        mapUrl = cfgUrl.mapUrl;

    init();

    function init() {
        map = new SuperMap.Map("map", {
            controls: [
                new SuperMap.Control.ScaleLine(),
                new SuperMap.Control.Zoom(),
                new SuperMap.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                })
            ]
        });
        map.addControl(new SuperMap.Control.LayerSwitcher(), new SuperMap.Pixel(42, 80));
        vectorLayer = new SuperMap.Layer.Vector("Vector Layer");
        //新建点矢量图层
        pointLayer = new SuperMap.Layer.Vector("pointLayer");

        for (var k in mapUrl) {
            var areaLayer = new SuperMap.Layer.TiledDynamicRESTLayer("XinJiang_Citys@China_Citys", mapUrl[k], {
                transparent: true,
                cacheEnabled: true
            }, { maxResolution: "auto" });

            areaLayerObj[k] = areaLayer;
            areaLayerArray.push(areaLayer);
        }

        for (var i = 0; i < areaLayerArray.length; i++) {
            if (i === (areaLayerArray.length - 1)) {
                var lastLayer = areaLayerArray[i]
                lastLayer.events.on({
                    "layerInitialized": function() {
                        var resLayer = areaLayerArray.concat(pointLayer, vectorLayer);
                        lastLayer.isBaseLayer = true;
                        map.addLayers(resLayer);
                        map.setCenter(new SuperMap.LonLat(9453654.35, 5190100.64), 0);
                    }
                });
            } else {
                var forLayer = areaLayerArray[i];
                forLayer.events.on({
                    "layerInitialized": function() {
                        forLayer.isBaseLayer = true;
                    }
                });
            }
        }

        map.events.on({
            'click': function(evt) {
                var pixel = new SuperMap.Pixel(evt.clientX, evt.clientY),
                    lonlat = map.getLonLatFromPixel(pixel);
                queryBySQL(lonlat)
            }
        })
    }

    function queryBySQL(lonlat) {
        vectorLayer.removeAllFeatures();
        pointLayer.removeAllFeatures();
        var point = new SuperMap.Geometry.Point(lonlat.lon, lonlat.lat);
        var feature = new SuperMap.Feature.Vector(point);
        pointLayer.addFeatures([feature]);

        var queryParam, queryByGeometryParameters, queryService;
        queryParam = new SuperMap.REST.FilterParameter({
            name: "XinJiang_Citys@China_Citys"
        });
        queryByGeometryParameters = new SuperMap.REST.QueryByGeometryParameters({
            queryParams: [queryParam],
            geometry: feature.geometry
            // spatialQueryMode: SuperMap.REST.SpatialQueryMode.INTERSECT
        });
        queryService = new SuperMap.REST.QueryByGeometryService(mapUrl.XinJiang, {
            eventListeners: {
                "processCompleted": processBySQLCompleted,
                "processFailed": processBySQLFailed
            }
        });
        queryService.processAsync(queryByGeometryParameters);
    }

    function processBySQLCompleted(queryEventArgs) {
        var i, j, feature,
            result = queryEventArgs.result;
        if (result && result.recordsets) {
            for (i = 0; i < result.recordsets.length; i++) {
                if (result.recordsets[i].features) {
                    for (j = 0; j < result.recordsets[i].features.length; j++) {
                        feature = result.recordsets[i].features[j];
                        feature.style = style;
                        console.log('queryBySQL feature++++++', feature)
                        // vectorLayer.addFeatures(feature);

                        var showLayer = areaLayerObj[cfgUrl.name[feature.attributes.NAME]]
                        var showPointCenter = cfgUrl.point[cfgUrl.name[feature.attributes.NAME]].split(',')

                        areaLayerArray[0].setVisibility(false);
                        showLayer.setVisibility(true);
                        // areaLayerArray[0].removeAllFeatures();
                        map.setCenter(new SuperMap.LonLat(showPointCenter[0], showPointCenter[1]), 0);
                        map.setBaseLayer(showLayer);
                    }
                }
            }
        }
    }

    function processBySQLFailed(e) {
        console.log(e)
    }
    </script>
</body>

</html>